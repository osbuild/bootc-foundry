# Containerfile for {{ distro }}-{{ version }} {{ image_type }}
FROM {{ base_image }}

ARG TARGETARCH
ARG CONTAINERFILE

RUN dnf install -y --skip-unavailable \
{% if image_type in ["ec2", "azure", "qcow2"] %}
	"cloud-init" \
	"cloud-utils-growpart" \
	"rsync" \
{% endif %}
{% if image_type in ["ec2", "gce", "qcow2"] %}
	"@core" \
	"chrony" \
	"tar" \
	"tuned" \
{% endif %}
{% if image_type == "ec2" %}
	"NetworkManager-cloud-setup" \
	"authselect-compat" \
	"dhcp-client" \
	"dracut-config-generic" \
	"gdisk" \
	"langpacks-en" \
	"redhat-release" \
	"redhat-release-eula" \
	"system-reinstall-bootc" \
	"yum-utils" \
	--exclude="firewalld" \
	--exclude="qemu-guest-agent" \
{% endif %}
{% if image_type == "azure" %}
    "@Server" \
    "NetworkManager" \
    "NetworkManager-cloud-setup" \
    "WALinuxAgent" \
    "azure-vm-utils" \
    "bzip2" \
    "efibootmgr" \
    "gdisk" \
    "hyperv-daemons" \
    "langpacks-en" \
    "lvm2" \
    "nvme-cli" \
    "patch" \
    "rng-tools" \
    "selinux-policy-targeted" \
    "system-reinstall-bootc" \
    "uuid" \
    "yum-utils" \
    --exclude="NetworkManager-config-server" \
    --exclude="bolt" \
    --exclude="buildah" \
    --exclude="cockpit-podman" \
    --exclude="containernetworking-plugins" \
    --exclude="dnf-plugin-spacewalk" \
    --exclude="glibc-all-langpacks" \
    --exclude="initscripts-rename-device" \
    --exclude="microcode_ctl" \
    --exclude="podman" \
    --exclude="python3-dnf-plugin-spacewalk" \
    --exclude="python3-hwdata" \
    --exclude="python3-rhnlib" \
    --exclude="rhn-check" \
    --exclude="rhn-client-tools" \
    --exclude="rhn-setup" \
    --exclude="rhnlib" \
    --exclude="rhnsd" \
    --exclude="usb_modeswitch" \
{% endif %}
{% if image_type == "gce" %}
	"acpid" \
	"dhcp-client" \
	"dnf-automatic" \
	"gce-disk-expand" \
	"google-compute-engine" \
	"google-osconfig-agent" \
	"grub2-tools" \
	"grub2-tools-minimal" \
	"langpacks-en" \
	"net-tools" \
	"python3" \
	"rng-tools" \
	"timedatex" \
	"vim" \
	--exclude="alsa-utils" \
	--exclude="b43-fwcutter" \
	--exclude="b43-openfwwf" \
	--exclude="dmraid" \
	--exclude="eject" \
	--exclude="gpm" \
	--exclude="irqbalance" \
	--exclude="microcode_ctl" \
	--exclude="qemu-guest-agent" \
	--exclude="smartmontools" \
{% endif %}
{% if image_type == "qcow2" %}
	"authselect-compat" \
	"cockpit-system" \
	"cockpit-ws" \
	"dnf-utils" \
	"dosfstools" \
	"nfs-utils" \
	"oddjob" \
	"oddjob-mkhomedir" \
	"psmisc" \
	"python3-jsonschema" \
	"qemu-guest-agent" \
	"redhat-release" \
	"redhat-release-eula" \
	"tcpdump" \
	--exclude="dnf-plugin-spacewalk" \
	--exclude="fedora-release" \
	--exclude="fedora-repos" \
	--exclude="firewalld" \
	--exclude="langpacks-*" \
	--exclude="langpacks-en" \
	--exclude="nss" \
	--exclude="rng-tools" \
	--exclude="udisks2" \
{% endif %}
{% if image_type in ["ec2", "azure", "gce", "qcow2"] %}
	--exclude="dracut-config-rescue" \
{% endif %}
{% if image_type in ["ec2", "azure", "qcow2"] %}
	--exclude="alsa-lib" \
	--exclude="biosdevname" \
	--exclude="iprutils" \
	--exclude="plymouth" \
{% endif %}
    --exclude="*-firmware" && \
    dnf clean all && \
    rm -rf /var/cache/dnf

{% if image_type == "ec2" %}
RUN echo 'kargs = ["console=tty0 console=ttyS0,115200n8 net.ifnames=0 nvme_core.io_timeout=4294967295"]' > /usr/lib/bootc/kargs.d/50-ec2.toml
{% endif %}
{% if image_type == "azure" %}
RUN echo 'kargs = ["ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300"]' > /usr/lib/bootc/kargs.d/50-azure.toml
{% endif %}
{% if image_type == "gce" %}
RUN echo 'kargs = ["net.ifnames=0 biosdevname=0 scsi_mod.use_blk_mq=Y console=ttyS0,38400n8d"]' > /usr/lib/bootc/kargs.d/50-gce.toml
{% endif %}
{% if image_type == "qcow2" %}
RUN echo 'kargs = ["console=tty0 console=ttyS0,115200n8 net.ifnames=0"]' > /usr/lib/bootc/kargs.d/50-qcow2.toml
{% endif %}

{% if image_type == "ec2" %}
RUN systemctl enable \
    "NetworkManager" \
    "cloud-config" \
    "cloud-final" \
    "cloud-init" \
    "cloud-init-local" \
    "nm-cloud-setup.service" \
    "nm-cloud-setup.timer" \
    "reboot.target" \
    "sshd" \
    "tuned"
{% endif %}
{% if image_type == "azure" %}
RUN systemctl enable \
    "firewalld" \
    "nm-cloud-setup.service" \
    "nm-cloud-setup.timer" \
    "sshd" \
    "waagent"
{% endif %}
{% if image_type == "gce" %}
RUN systemctl enable \
    "dnf-automatic.timer" \
    "rngd" \
    "sshd" && \
    systemctl disable "reboot.target" "sshd-keygen@"
{% endif %}
{% if image_type == "qcow2" %}
# XXX: https://gitlab.com/redhat/centos-stream/rpms/centos-stream-release/-/blob/c10s/90-default.preset?ref_type=heads#L460-465
{% endif %}

COPY $CONTAINERFILE /root/Containerfile
